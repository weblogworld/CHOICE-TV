<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CHOICE TV — Live + VOD</title>
  <style>
    :root{--accent:#e64a3b;--muted:#6b7280;--bg:#f7f7f8}
    html,body,#app{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{background:var(--bg);color:#111}
    header{background:#0f1724;color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    header nav a{color:#fff;margin-left:12px;text-decoration:none}
    .wrap{padding:16px;max-width:1100px;margin:14px auto}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 1px 6px rgba(2,6,23,0.06)}
    .player video{width:100%;height:420px;background:#000;border-radius:8px}
    h2{margin:0 0 10px 0}
    .small{font-size:13px;color:var(--muted)}
    input,select,textarea{width:100%;padding:8px;margin-top:8px;border:1px solid #e6e7eb;border-radius:6px}
    button{background:var(--accent);color:#fff;padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
    .btn-ghost{background:#f3f4f6;color:#111;border:1px solid #e6e7eb}
    .row{display:flex;gap:8px;align-items:center}
    .list{max-height:300px;overflow:auto}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .share-buttons a{display:inline-block;margin-right:8px;margin-top:8px;text-decoration:none}
    .status{font-size:13px;color:#7a2b22;background:#fff7f6;padding:8px;border-radius:6px;border:1px solid #f5d6d3}
  </style>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>CHOICE TV — Live & VOD</h1>
      <nav>
        <a href="#now">Now</a>
        <a href="#schedule">Schedule</a>
        <a href="#admin">Admin</a>
      </nav>
    </header>

    <main class="wrap">
      <div class="grid">
        <section class="card">
          <h2 id="now-title">Now Playing</h2>
          <div class="small" id="now-meta">Loading...</div>
          <div class="player" style="margin-top:12px">
            <video id="player" controls poster="" playsinline></video>
          </div>
          <p id="now-desc" class="small" style="margin-top:10px"></p>

          <div style="margin-top:14px" class="card">
            <h3 style="margin:0 0 8px 0">Live Preview (your camera)</h3>
            <video id="localPreview" autoplay muted playsinline style="width:100%;height:240px;background:#000;border-radius:6px"></video>
            <div style="margin-top:8px" class="row">
              <button id="btn-start-preview" class="btn-ghost">Start Camera</button>
              <button id="btn-stop-preview" class="btn-ghost" style="display:none">Stop Camera</button>
            </div>
            <div style="margin-top:10px" class="small">
              Use the preview to check camera & mic before going live.
            </div>
          </div>
        </section>

        <aside>
          <section id="auth-card" class="card">
            <h2>Admin</h2>
            <div id="auth-area">
              <p class="small">Sign in with Google to upload VOD, manage schedule, and go live.</p>
              <div style="margin-top:8px" class="row">
                <button id="btn-signin">Sign in with Google</button>
                <button id="btn-signout" class="btn-ghost" style="display:none">Sign out</button>
              </div>
              <div id="user-info" class="small" style="margin-top:8px"></div>
            </div>
          </section>

          <section class="card" style="margin-top:12px">
            <h3 style="margin:0 0 8px 0">Go Live (Browser → Relay)</h3>

            <label class="small">RTMP Destination (optional)</label>
            <input id="input-rtmp" placeholder="rtmp://a.rtmp.youtube.com/live2/STREAM_KEY or leave blank to only publish HLS on relay" />
            <div class="small" style="margin-top:6px">
              If you provide an RTMP URL the relay server will forward your stream to that destination (YouTube/Facebook/Twitch).
            </div>

            <label class="small" style="margin-top:8px">Relay WebSocket URL</label>
            <input id="input-ws" placeholder="wss://your-relay.example.com/live" value="wss://your-relay.example.com/live" />

            <div style="margin-top:10px" class="row">
              <button id="btn-go-live" class="button">Start Broadcast</button>
              <button id="btn-stop-live" class="btn-ghost" style="display:none">Stop Broadcast</button>
            </div>

            <div id="live-status" class="small" style="margin-top:10px"></div>
            <div id="live-controls" style="margin-top:10px;display:none">
              <label class="small">Share this live URL</label>
              <div class="share-buttons">
                <a id="share-twitter" href="#" target="_blank">Twitter</a>
                <a id="share-facebook" href="#" target="_blank">Facebook</a>
                <a id="share-whatsapp" href="#" target="_blank">WhatsApp</a>
                <a id="share-copy" href="#" onclick="event.preventDefault();">Copy Link</a>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:12px">
            <h3 style="margin:0 0 8px 0">Upload VOD</h3>
            <input id="input-title" placeholder="Title" />
            <textarea id="input-desc" rows="3" placeholder="Description"></textarea>
            <label class="small" style="margin-top:6px">Video file (MP4)</label>
            <input id="input-file" type="file" accept="video/*" />
            <div style="margin-top:8px" class="row">
              <button id="btn-upload">Upload & Save</button>
            </div>
            <div id="upload-status" class="small" style="margin-top:8px"></div>
          </section>

          <section class="card" style="margin-top:12px">
            <h3 style="margin:0 0 8px 0">Schedule</h3>
            <div class="small">Use the Firestore console or the Admin UI (from earlier single-file version) to create schedule entries that point to uploaded assets.</div>
          </section>
        </aside>
      </div>

      <footer>
        <div class="small">CHOICE TV — demo web channel • Use a relay server to publish RTMP/HLS for viewers and social platforms</div>
      </footer>
    </main>
  </div>

  <script>
  /********************************************************************************
   * CHOICE TV — Client (single-file)
   *
   * This file extends the single-file demo with:
   *  - Webcam preview (getUserMedia)
   *  - Browser MediaRecorder -> WebSocket relay to a server which pipes to ffmpeg -> RTMP/HLS
   *  - Social sharing buttons that share the public live URL (you must set the public viewer URL)
   *
   * The relay server is required to accept WebSocket binary chunks from the browser and push to ffmpeg.
   * Server example available in README and provided as server files.
   *
   * SECURITY: Do not embed server-side service account keys in this client file.
   ********************************************************************************/

  // ------------------ FIREBASE CONFIG (client web config) ------------------
  // Replace with your own values or keep as provided locally.
  const firebaseConfig = {
    apiKey: "AlzaSyDATAoG9u7sIKVzT0BxQH5ZWDhVwMM2WSk",
    authDomain: "innovative-world-of-congress.firebaseapp.com",
    projectId: "innovative-world-of-congress",
    storageBucket: "innovative-world-of-congress.appspot.com",
    messagingSenderId: "728669966037",
    appId: "1:728669966037:web:457cdda570e5b4d5b39c5c",
    measurementId: "G-WF48778976"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // UI refs
  const player = document.getElementById('player');
  const nowTitle = document.getElementById('now-title');
  const nowMeta = document.getElementById('now-meta');
  const nowDesc = document.getElementById('now-desc');
  const localPreview = document.getElementById('localPreview');

  const btnStartPreview = document.getElementById('btn-start-preview');
  const btnStopPreview = document.getElementById('btn-stop-preview');

  const btnSignIn = document.getElementById('btn-signin');
  const btnSignOut = document.getElementById('btn-signout');
  const userInfo = document.getElementById('user-info');

  const inputFile = document.getElementById('input-file');
  const btnUpload = document.getElementById('btn-upload');
  const uploadStatus = document.getElementById('upload-status');
  const inputTitle = document.getElementById('input-title');
  const inputDesc = document.getElementById('input-desc');

  const inputWs = document.getElementById('input-ws');
  const inputRtmp = document.getElementById('input-rtmp');
  const btnGoLive = document.getElementById('btn-go-live');
  const btnStopLive = document.getElementById('btn-stop-live');
  const liveStatus = document.getElementById('live-status');
  const liveControls = document.getElementById('live-controls');
  const shareTwitter = document.getElementById('share-twitter');
  const shareFacebook = document.getElementById('share-facebook');
  const shareWhatsapp = document.getElementById('share-whatsapp');
  const shareCopy = document.getElementById('share-copy');

  // ---------- HLS playback helper ----------
  function playUrl(url, poster) {
    if (!url) {
      player.removeAttribute('src');
      return;
    }
    if (Hls.isSupported() && url.endsWith('.m3u8')) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(player);
    } else {
      player.src = url;
    }
    if (poster) player.setAttribute('poster', poster);
  }

  // ---------- Load schedule / now logic (same as earlier simplified version) ----------
  async function refreshNow() {
    nowMeta.textContent = 'Loading...';
    try {
      const snaps = await db.collection('schedule').orderBy('start', 'asc').get();
      const items = snaps.docs.map(d => ({ id: d.id, ...d.data() }));
      const now = new Date();
      const current = items.find(it => {
        if (!it.start || !it.end) return false;
        const s = it.start.toDate ? it.start.toDate() : new Date(it.start);
        const e = it.end.toDate ? it.end.toDate() : new Date(it.end);
        return now >= s && now < e;
      });
      if (current && current.assetId) {
        const aDoc = await db.collection('assets').doc(current.assetId).get();
        if (aDoc.exists) {
          const asset = aDoc.data();
          nowTitle.textContent = 'Now Playing';
          nowMeta.textContent = 'Scheduled: ' + (asset.title || 'Untitled');
          nowDesc.textContent = asset.description || '';
          playUrl(asset.playbackUrl, asset.thumbnailUrl || '');
          return;
        }
      }
      // fallback to latest asset
      const assetsSnap = await db.collection('assets').orderBy('createdAt','desc').limit(1).get();
      if (!assetsSnap.empty) {
        const asset = assetsSnap.docs[0].data();
        nowTitle.textContent = 'Featured';
        nowMeta.textContent = asset.title || 'Untitled';
        nowDesc.textContent = asset.description || '';
        playUrl(asset.playbackUrl, asset.thumbnailUrl || '');
      } else {
        nowTitle.textContent = 'Now Playing';
        nowMeta.textContent = 'No content available';
        nowDesc.textContent = '';
        player.removeAttribute('src');
      }
    } catch (err) {
      console.error(err);
      nowMeta.textContent = 'Error loading now: ' + err.message;
    }
  }
  refreshNow();

  // ---------- Auth ----------
  btnSignIn.addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try { await auth.signInWithPopup(provider); } catch (err) { alert('Sign in error: ' + err.message); }
  });
  btnSignOut.addEventListener('click', async () => { await auth.signOut(); });

  auth.onAuthStateChanged(user => {
    if (user) {
      userInfo.textContent = user.displayName + ' • ' + user.email;
      btnSignIn.style.display = 'none'; btnSignOut.style.display = 'inline-block';
    } else {
      userInfo.textContent = ''; btnSignIn.style.display = 'inline-block'; btnSignOut.style.display = 'none';
    }
  });

  // ---------- Preview (getUserMedia) ----------
  let previewStream = null;
  btnStartPreview.addEventListener('click', async () => {
    try {
      previewStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localPreview.srcObject = previewStream;
      btnStartPreview.style.display = 'none';
      btnStopPreview.style.display = 'inline-block';
    } catch (err) {
      alert('Camera error: ' + err.message);
    }
  });
  btnStopPreview.addEventListener('click', () => {
    if (previewStream) {
      previewStream.getTracks().forEach(t => t.stop());
      previewStream = null;
      localPreview.srcObject = null;
    }
    btnStartPreview.style.display = 'inline-block';
    btnStopPreview.style.display = 'none';
  });

  // ---------- Upload VOD ----------
  btnUpload.addEventListener('click', async () => {
    if (!auth.currentUser) { alert('Sign in first'); return; }
    const file = inputFile.files[0];
    if (!file) { alert('Choose a video file'); return; }
    uploadStatus.textContent = 'Uploading...';
    try {
      const path = 'videos/public/' + Date.now() + '_' + file.name.replace(/\s+/g,'_');
      const storageRef = storage.ref().child(path);
      const uploadTask = storageRef.put(file);
      uploadTask.on('state_changed', snap => {
        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
        uploadStatus.textContent = 'Uploading ' + pct + '%';
      });
      await uploadTask;
      const url = await storageRef.getDownloadURL();
      const docRef = await db.collection('assets').add({
        title: inputTitle.value || file.name,
        description: inputDesc.value || '',
        type: 'vod',
        playbackUrl: url,
        thumbnailUrl: '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      uploadStatus.textContent = 'Uploaded & saved: ' + docRef.id;
      inputFile.value = ''; inputTitle.value = ''; inputDesc.value = '';
      refreshNow();
    } catch (err) {
      console.error(err);
      uploadStatus.textContent = 'Upload error: ' + err.message;
    }
  });

  // ---------- Live (MediaRecorder -> WebSocket relay) ----------
  let mediaStream = null;
  let mediaRecorder = null;
  let ws = null;
  let isBroadcasting = false;

  btnGoLive.addEventListener('click', async () => {
    if (!auth.currentUser) { alert('Sign in first'); return; }
    const wsUrl = inputWs.value.trim();
    if (!wsUrl) { alert('Set relay WebSocket URL (server)'); return; }

    try {
      // start camera if not already
      if (!previewStream) {
        previewStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localPreview.srcObject = previewStream;
      }

      mediaStream = previewStream;
      // prefer codecs: webm (vp8/opus) for high compatibility with ffmpeg ingest
      const options = { mimeType: 'video/webm;codecs=vp8,opus' };
      mediaRecorder = new MediaRecorder(mediaStream, options);

      // open ws
      ws = new WebSocket(wsUrl);
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        // send "start" message with RTMP destination (if provided)
        const dest = inputRtmp.value.trim() || null;
        ws.send(JSON.stringify({ action: 'start', rtmp: dest }));
        liveStatus.textContent = 'Connected to relay — starting stream';
        // start recording and sending
        mediaRecorder.start(1000); // emit blobs every 1s
        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
            e.data.arrayBuffer().then(buf => {
              // send binary chunk framed with a small header (could be just raw)
              ws.send(buf);
            });
          }
        };
        mediaRecorder.onstop = () => {
          // notify server
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ action: 'stop' }));
          }
        };
        isBroadcasting = true;
        btnGoLive.style.display = 'none';
        btnStopLive.style.display = 'inline-block';
        liveControls.style.display = 'block';
        // populate share buttons with a public viewer URL (you should set your real public URL)
        const viewerUrl = window.location.href.split('#')[0]; // default to current page
        shareTwitter.href = `https://twitter.com/intent/tweet?text=I'm+live+on+CHOICE+TV!&url=${encodeURIComponent(viewerUrl)}`;
        shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(viewerUrl)}`;
        shareWhatsapp.href = `https://wa.me/?text=${encodeURIComponent("I'm live on CHOICE TV: " + viewerUrl)}`;
        shareCopy.addEventListener('click', async (ev) => {
          ev.preventDefault();
          try { await navigator.clipboard.writeText(viewerUrl); alert('Link copied'); } catch (e) { alert('Copy failed'); }
        });
      };

      ws.onmessage = (msg) => {
        // server can send JSON messages about HLS playback URL or status
        try {
          const text = typeof msg.data === 'string' ? msg.data : null;
          if (text) {
            const json = JSON.parse(text);
            if (json.type === 'hls' && json.url) {
              liveStatus.textContent = 'Relay published HLS: ' + json.url;
              // update player to watch the live HLS if you want
              playUrl(json.url);
            } else if (json.type === 'status') {
              liveStatus.textContent = 'Relay: ' + json.msg;
            }
          }
        } catch (err) {
          console.warn('ws message parse', err);
        }
      };

      ws.onerror = (e) => { console.error('WebSocket error', e); liveStatus.textContent = 'Relay connection error'; };
      ws.onclose = () => {
        liveStatus.textContent = 'Relay disconnected';
        stopLocalBroadcast();
      };
    } catch (err) {
      console.error(err);
      alert('Live start error: ' + err.message);
    }
  });

  btnStopLive.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: 'stop' }));
    if (ws) ws.close();
    liveStatus.textContent = 'Broadcast stopped';
    isBroadcasting = false;
    btnGoLive.style.display = 'inline-block';
    btnStopLive.style.display = 'none';
  });

  function stopLocalBroadcast() {
    try {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      mediaRecorder = null;
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
        localPreview.srcObject = null;
        previewStream = null;
      }
      if (ws && ws.readyState !== WebSocket.CLOSED) ws.close();
      ws = null;
      isBroadcasting = false;
      btnGoLive.style.display = 'inline-block';
      btnStopLive.style.display = 'none';
    } catch (e) { console.warn(e); }
  }

  // clean up on page unload
  window.addEventListener('beforeunload', () => { try { stopLocalBroadcast(); } catch (e) {} });

  </script>
</body>
</html>
